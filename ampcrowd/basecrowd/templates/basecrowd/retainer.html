{% extends base_template_name %}
<!-- Add HTML to display an interface to the crowd for completing tasks of a new type.

This template will display a single-screen interface to the crowd for gathering labels of one or more items of the same
task type. To define your task type, copy this template, then fill in the blocks below.

Note: Twitter Bootstrap CSS classes will be available for styling.

-->

<!-- Load the retainer library -->
{% block jslibraries %}
    {{ block.super }}
    <script type='text/javascript' src='/static/basecrowd/js/retainer.js'></script>
{% endblock jslibraries %}

<!-- Don't include javascript we don't need. -->
{% block validate_func %}
{% endblock validate_func %}

{% block initialize_form_validation_func %}
{% endblock initialize_form_validation_func %}

<!-- Initialization -->
{% block handle_is_accepted_func %}
function start_work()
{
    // Set up retainer tracking
    PING_ENDPOINT = "/crowds/{{ crowd_name }}/retainer/ping/";
    WORK_ENDPOINT = "/crowds/{{ crowd_name }}/assignments/retainer/";
    Retainer.init(PING_ENDPOINT, WORK_ENDPOINT);

    // Set up exit button
    $("#exitButton").click(function(event) {
        event.preventDefault();
        var data = prepare_submit_data();
        submit_to_frontend(data);
    });
}

function handle_is_accepted()
{
    var is_accepted = {{ is_accepted|yesno:"true,false" }};
    var understands_retainer = {{ understands_retainer|yesno:"true,false" }};
    if (is_accepted)
    {
        if (!understands_retainer)
        {
            // Pop up the instructions
            var modal = $('#instructionsModal');
            modal.on('hidden.bs.modal', function(e) {
                $.post("/crowds/{{ crowd_name }}/workers/{{ worker_id }}/understands_retainer");
                start_work();
            });
            modal.modal('show');
        }

        else {
            start_work();
        }
    }
    else
    {
        // Show the instructions
        $('#instructionsModal').modal('show')
    }
}
{% endblock handle_is_accepted_func %}

{% block ready_func %}
$(document).ready(function()
{
    handle_is_accepted();
});
{% endblock ready_func %}

<!-- Layout and Content -->


<!-- Override standard layout -->
{% block body %}

<!-- Modal w/ task instructions -->
<div class="modal fade" data-show="false" id="instructionsModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
	<button type="button" class="close" data-dismiss="modal" aria-label="Close">
	  <span aria-hidden="true">&times;</span>
	</button>
        <h4 class="modal-title">Retainer Pool Instructions</h4>
      </div>
      <div class="modal-body">
	<p>Instructions will be written here!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Get to work!</button>
      </div>
    </div>
  </div>
</div>

<section class="container task-container">

  <!-- Retainer pool status -->
  <div class="row">
    <div class="col-xs-2 col-md-2">
      <p class="text-center"><big><em>Retainer Pool.</big></em></p>
    </div>
    <div class="col-xs-8 col-md-8">
      <p class="text-center">
	<big><em>Wait Time: <span id="waitTime">{{ wait_time|default:"0.00" }}</span> seconds.
	Tasks Completed: <span id="tasksCompleted">{{ tasks_completed|default:"0" }}</span>.</em></big>
      </p>
    </div>

    <!-- Button to stop working -->
    {% if is_accepted %}
    <div class="col-xs-2 col-md-2">
      <form id="submitForm" action="">
	<input type="hidden" value="{{ assignment_id }}" name="assignmentId" />
	<input type="hidden" value="0" name="dummyData" />
	<p>
	  <input type="submit" id="exitButton" class="btn btn-default btn-sm" value="Finish working" />
	</p>
      </form>
    </div>
    {% endif %}

    </div>
  </div>

  <div class="row">

    <!-- Looking for work -->
    <div class="well col-xs-12 col-md-12" id="waitingDiv">
      <h1>Waiting for next task...</h1>
      <p><big><em>Please keep this page open until the task begins. To earn your pay for waiting, you must be available as soon as you are alerted. Depending on your browser you will be alerted in different ways, but keep an eye out for a pop-up or flashing tab in your browser. Since you will be able to see the alert from other tabs, you are free to take other tasks while you wait, <b>as long as you do NOT close this tab</b>, as that will remove you from the waiting area.</em></big></p>
    </div>

    <!-- Task iframe, hidden to start -->
    <div class="col-xs-12 col-md-12">
      <iframe src="about:blank" id="taskFrame" frameborder="0" style="display:none;width:100%;"></iframe>
    </div>

  </div>
</section>
{% endblock body %}
